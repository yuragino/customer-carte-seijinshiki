<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <title>お客様カルテ - 成人式登録フォーム</title>
  <!-- Custom Script -->
  <script type="module" src="./js/form.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vanilla-autokana/dist/autokana.min.js" defer></script>
  <!-- Alpine.js -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.1/dist/cdn.min.js"></script>
  <!-- Styles -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/sanitize.css">
  <link rel="stylesheet" href="./css/layout.css">
  <link rel="stylesheet" href="./css/form.css">
</head>

<body x-data="app">
  <header class="header">
    <div class="header-inner">
      <h1 class="header-title"><a :href="`./index.html?year=${selectedYear}`">お客様カルテ</a></h1>
      <div class="header-controls">
        <select x-model.number="selectedYear">
          <template x-for="year in yearOptions" :key="year">
            <option :value="year" x-text="year" :selected="year === selectedYear"></option>
          </template>
        </select>
        <span>成人式</span>
      </div>
      <nav class="header-nav">
        <a :href="`./statistics.html?year=${selectedYear}`">統計情報</a>
        <a :href="`./schedule.html?year=${selectedYear}`">受付管理</a>
        <a :href="`./image-carte.html?year=${selectedYear}`">画像検索</a>
        <a :href="`./form_html?year=${selectedYear}`">新規登録</a>
      </nav>
    </div>
  </header>
  <div class="cancellation-status" x-show="representative.isCanceled === true">この予約はすでにキャンセルされています</div>
  <div class="delete-container">
    <button type="button" class="delete-btn" x-show="currentGroupId" @click="deleteForm">
      <i class="fa-regular fa-trash-can"></i> カルテを削除
    </button>
  </div>
  <form @submit.prevent="submitForm">
    <main>
      <div class="card">
        <h2>
          <i class="fa-regular fa-circle-user"></i>
          <span>基本情報</span>
        </h2>
        <table>
          <tr>
            <th>予約受付日</th>
            <td><input type="date" x-model="formData.basic.reservationDate"></td>
          </tr>
          <tr>
            <th>名前</th>
            <td><input type="text" placeholder="山田 花子" x-model="formData.basic.name" id="name"></td>
          </tr>
          <tr>
            <th>フリガナ</th>
            <td><input type="text" placeholder="ヤマダ ハナコ" x-model="formData.basic.kana" id="furigana"></td>
          </tr>
          <tr>
            <th>紹介者</th>
            <td><input type="text" x-model="formData.basic.introducer"></td>
          </tr>
          <tr>
            <th>住所</th>
            <td><input type="text" x-model="formData.basic.address"></td>
          </tr>
          <tr>
            <th>LINE</th>
            <td class="radio-group">
              <label><input type="radio" value="教室LINE" x-model="formData.basic.lineType"> 教室LINE</label>
              <label><input type="radio" value="椿LINE" x-model="formData.basic.lineType"> 椿LINE</label>
              <label><input type="radio" value="お客様LINE" x-model="formData.basic.lineType"> お客様LINE</label>
            </td>
          </tr>
          <tr>
            <th>電話番号</th>
            <td><input type="tel" placeholder="09012345678" x-model="formData.basic.phone"></td>
          </tr>
          <tr>
            <th>身長</th>
            <td><input type="number" x-model="formData.basic.height"> cm</td>
          </tr>
          <tr>
            <th>足サイズ</th>
            <td><input type="number" x-model="formData.basic.footSize"> cm</td>
          </tr>
          <tr>
            <th>衣装</th>
            <td>
              <button class="toggle-btn" :class="formData.basic.outfit === '振袖' ? 'active-yes':'inactive'"
                @click="formData.basic.outfit = '振袖'">振袖</button>
              <button class="toggle-btn" :class="formData.basic.outfit === '袴' ? 'active-yes':'inactive'"
                @click="formData.basic.outfit = '袴'">袴</button>
            </td>
          </tr>
          <tr x-show="formData.basic.outfit">
            <th>利用形態</th>
            <td class="radio-group">
              <label><input type="radio" value="自前" x-model="formData.basic.rentalType"> 自前</label>
              <label><input type="radio" value="レンタル" x-model="formData.basic.rentalType"> レンタル</label>
              <label><input type="radio" value="一部レンタル" x-model="formData.basic.rentalType"> 一部レンタル</label>
            </td>
          </tr>
          <tr x-show="formData.basic.outfit === '振袖'">
            <th>ヘアメイク担当</th>
            <td><input type="text" x-model="formData.basic.hairMakeStaff"></td>
          </tr>
          <tr x-show="formData.basic.outfit">
            <th>備考</th>
            <td><textarea rows="2" x-model="formData.basic.outfitMemo"></textarea></td>
          </tr>
        </table>
      </div>

      <!-- 当日スケジュール -->
      <div class="card toujitsu-card">
        <h2>
          <i class="fa-regular fa-calendar-check"></i>
          <span>当日スケジュール</span>
          <button @click="swapSchedule()" class="btn title-actions" x-show="formData.basic.outfit === '振袖'">
            <i class="fa-solid fa-arrows-up-down"></i>
            <span>入れ替え</span>
          </button>
        </h2>
        <table>
          <!-- 振袖モード: ヘア＋着付 -->
          <template x-if="formData.basic.outfit === '振袖'">
            <template x-for="task in formData.toujitsu.schedule" :key="task.id">
              <tr>
                <th x-text="task.type === 'hair' ? 'ヘアメイク時間' : '着付時間'"></th>
                <td>
                  <input type="time" x-model="task.start"> 〜
                  <input type="time" x-model="task.end">
                </td>
              </tr>
            </template>
          </template>
          <!-- 袴モード: 着付だけ -->
          <template x-if="formData.basic.outfit === '袴'">
            <tr>
              <th>着付時間</th>
              <td>
                <input type="time" x-model="formData.toujitsu.schedule.find(t => t.type === 'kitsuke').start"> 〜
                <input type="time" x-model="formData.toujitsu.schedule.find(t => t.type === 'kitsuke').end">
              </td>
            </tr>
          </template>

          <!-- 備考 -->
          <tr>
            <th>備考</th>
            <td>
              <textarea x-model="formData.toujitsu.note" rows="2"></textarea>
            </td>
          </tr>
        </table>
      </div>

      <!-- 打ち合わせ・お預かり -->
      <div class="card meeting-card">
        <h2>
          <i class="fa-regular fa-calendar-days"></i>
          <span>打ち合わせ・お預かり</span>
          <button class="btn title-actions" @click="openMeetingModal()">
            <i class="fa-regular fa-plus"></i>
            <span>追加</span>
          </button>
        </h2>
        <table>
          <thead>
            <tr>
              <th>種別</th>
              <th>日時</th>
              <th>場所</th>
              <th>備考</th>
              <th></th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <template x-for="(item, index) in sortedMeetings" :key="index">
              <tr>
                <td x-text="item.type"></td>
                <td x-text="formatDisplayDate(item.date)"></td>
                <td x-text="item.place"></td>
                <td x-text="item.note"></td>
                <td>
                  <button class="btn-edit" @click="editMeeting(index)">
                    <i class="fa-solid fa-pen"></i>
                  </button>
                </td>
                <td>
                  <button class="btn-del" @click="deleteMeeting(index)">
                    <i class="fa-solid fa-trash"></i>
                  </button>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>

      <!-- モーダル -->
      <div x-show="meetingModalVisible" class="modal-bg" @click.self="closeMeetingModal()">
        <div class="modal-box">
          <i class="fa-solid fa-xmark close-btn" @click="closeMeetingModal()"></i>

          <div>
            <label>種別</label>
            <div>
              <button class="toggle-btn" :class="meetingForm.type === '打ち合わせ' ? 'active-yes':'inactive'"
                @click="meetingForm.type = '打ち合わせ'">
                <i class="fa-solid fa-handshake"></i> 打ち合わせ
              </button>
              <button class="toggle-btn" :class="meetingForm.type === 'お預かり' ? 'active-yes':'inactive'"
                @click="meetingForm.type = 'お預かり'">
                <i class="fa-solid fa-box"></i> お預かり
              </button>
            </div>
          </div>

          <div style="margin-top:1rem;">
            <label>日時</label>
            <input type="datetime-local" x-model="meetingForm.date">
          </div>

          <div style="margin-top:1rem;">
            <label>場所</label>
            <input type="text" x-model="meetingForm.place">
          </div>

          <div style="margin-top:1rem;">
            <label>備考</label>
            <textarea x-model="meetingForm.note"></textarea>
          </div>

          <div class="modal-actions">
            <button class="btn" @click="saveMeeting()">保存</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>
          <i class="fa-solid fa-camera-retro"></i>
          <span>前撮り</span>
          <div class="title-actions">
            <button class="toggle-btn" :class="formData.maedoriStatus === 'あり' ? 'active-yes' : 'inactive'"
              @click="formData.maedoriStatus = 'あり'">
              <i class="fa-solid fa-circle-check"></i> あり
            </button>
            <button class="toggle-btn" :class="formData.maedoriStatus === 'なし' ? 'active-no' : 'inactive'"
              @click="formData.maedoriStatus = 'なし'">
              <i class="fa-solid fa-circle-xmark"></i> なし
            </button>
          </div>
        </h2>

        <!-- 「あり」の場合 -->
        <table x-show="formData.maedoriStatus === 'あり'">
          <tr>
            <th>種類</th>
            <td>
              <select x-model="formData.maedori.type">
                <option>スタジオ</option>
                <option>ロケ</option>
                <option>スタジオ＆ロケ</option>
              </select>
            </td>
          </tr>
          <tr>
            <th>カメラマン</th>
            <td><input type="text" x-model="formData.maedori.camera"></td>
          </tr>
          <tr>
            <th>撮影日</th>
            <td><input type="date" x-model="formData.maedori.date"></td>
          </tr>
          <tr>
            <th>ヘア時間</th>
            <td><input type="time" x-model="formData.maedori.hairStart"> 〜 <input type="time"
                x-model="formData.maedori.hairEnd"></td>
          </tr>
          <tr>
            <th>着付時間</th>
            <td><input type="time" x-model="formData.maedori.kitsukeStart"> 〜 <input type="time"
                x-model="formData.maedori.kitsukeEnd"></td>
          </tr>
          <tr>
            <th>撮影時間</th>
            <td><input type="time" x-model="formData.maedori.shootStart"> 〜 <input type="time"
                x-model="formData.maedori.shootEnd"></td>
          </tr>
          <tr>
            <th>着付場所</th>
            <td><input type="text" x-model="formData.maedori.place"></td>
          </tr>
          <tr>
            <th>備考</th>
            <td><textarea x-model="formData.maedori.note"></textarea></td>
          </tr>
        </table>

        <!-- 「なし」の場合 -->
        <table x-show="formData.maedoriStatus === 'なし'">
          <tr>
            <th>備考</th>
            <td><textarea x-model="formData.maedori.note"></textarea></td>
          </tr>
        </table>
      </div>

      <!-- メディア -->
      <div class="card media-card">
        <h2><i class="fa-regular fa-images"></i> メディアアップロード</h2>
        <table>
          <tr>
            <th>画像</th>
            <td>
              <input type="file" multiple accept="image/*" @change="handleImageUpload($event, index)">
              <div class="preview-container">
                <template x-for="src in customer.imagePreviews" :key="src">
                  <img :src="src" class="preview-image">
                </template>
              </div>
            </td>
          </tr>
          <tr>
            <th>動画</th>
            <td><input type="file" multiple accept="video/*"></td>
          </tr>
        </table>
      </div>

      <!-- 見積もり -->
      <div class="card estimate-card">
        <h2>
          <i class="fa-solid fa-yen-sign"></i> 見積もり
          <button class="btn title-actions" @click="addOption()">
            <i class="fa-regular fa-plus"></i>
            <span>オプション追加</span>
          </button>
        </h2>
        <table>
          <tr>
            <th>項目</th>
            <th>当日</th>
            <th>前撮り</th>
            <th>金額</th>
            <th></th>
          </tr>

          <!-- 着付固定項目 -->
          <tr>
            <td>着付</td>
            <td class="clickable-cell">
              <label class="toggle-check">
                <input type="checkbox" x-model="estimateItems[0].toujitsu">
                <i class="fa-regular fa-circle-xmark"></i>
                <i class="fa-regular fa-circle-check"></i>
              </label>
            </td>
            <td class="clickable-cell">
              <label class="toggle-check">
                <input type="checkbox" x-model="estimateItems[0].maedori">
                <i class="fa-regular fa-circle-xmark"></i>
                <i class="fa-regular fa-circle-check"></i>
              </label>
            </td>
            <td>
              <!-- カンマ付き円表示 -->
              <div class="total" x-text="formatYen(calcPrice(estimateItems[0]))"></div>
            </td>
            <td></td>
          </tr>

          <!-- ヘア項目（振袖のときだけ） -->
          <tr x-show="formData.basic.outfit==='振袖'">
            <td>
              <select x-model="estimateItems[1].option">
                <option value="none">ヘアメイクなし</option>
                <option value="hairMake">ヘア＆メイク</option>
                <option value="hairOnly">ヘアのみ</option>
              </select>
            </td>
            <td class="clickable-cell">
              <template x-if="estimateItems[1].option==='none'">
                <span class="disabled-label">対象外</span>
              </template>
              <template x-if="estimateItems[1].option!=='none'">
                <label class="toggle-check">
                  <input type="checkbox" x-model="estimateItems[1].toujitsu">
                  <i class="fa-regular fa-circle-xmark"></i>
                  <i class="fa-regular fa-circle-check"></i>
                </label>
              </template>
            </td>
            <td class="clickable-cell">
              <template x-if="estimateItems[1].option==='none'">
                <span class="disabled-label">対象外</span>
              </template>
              <template x-if="estimateItems[1].option!=='none'">
                <label class="toggle-check">
                  <input type="checkbox" x-model="estimateItems[1].maedori">
                  <i class="fa-regular fa-circle-xmark"></i>
                  <i class="fa-regular fa-circle-check"></i>
                </label>
              </template>
            </td>
            <td>
              <div class="total" x-text="formatYen(calcPrice(estimateItems[1]))"></div>
            </td>
            <td></td>
          </tr>

          <!-- 追加オプション -->
          <template x-for="(item,i) in estimateItems.slice(2)" :key="i">
            <tr>
              <td><input type="text" x-model="item.name"></td>
              <td class="clickable-cell">
                <label class="toggle-check">
                  <input type="checkbox" x-model="item.toujitsu">
                  <i class="fa-regular fa-circle-xmark"></i>
                  <i class="fa-regular fa-circle-check"></i>
                </label>
              </td>
              <td class="clickable-cell">
                <label class="toggle-check">
                  <input type="checkbox" x-model="item.maedori">
                  <i class="fa-regular fa-circle-xmark"></i>
                  <i class="fa-regular fa-circle-check"></i>
                </label>
              </td>
              <td>
                <input type="number" x-model.number="item.price" style="width:80px; text-align:right;">
                <span>円</span>
              </td>
              <td>
                <button class="btn-del" @click="if(confirm('このオプションを削除しますか？')) estimateItems.splice(i+2,1)">
                  <i class="fa-solid fa-trash"></i>
                </button>
              </td>
            </tr>
          </template>

          <!-- 合計 -->
          <tr>
            <td colspan="3" style="text-align: center;">合計</td>
            <td class="total" x-text="formatYen(totalAmount)"></td>
            <td></td>
          </tr>
        </table>
      </div>

      <div class="card receipt-card">
        <h2><i class="fa-solid fa-receipt"></i> 領収情報</h2>
        <table>
          <tr>
            <th>領収日</th>
            <td>
              <input id="receiptDate" type="date" x-model="formData.estimate.receiptDate" required>
            </td>
          </tr>
        </table>
      </div>

      <div class="actions">
        <button type="submit" class="btn register-btn" x-text="currentGroupId ? '更新' : '登録'"></button>
      </div>
      <div class="cancellation-status" x-show="currentGroupId != null">
        <label for="cancellation-toggle">
          <input type="checkbox" id="cancellation-toggle" x-model="representative.isCanceled">
          <span>キャンセルの時はここにチェックをつける</span>
        </label>
      </div>
    </main>
  </form>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      AutoKana.bind('#name', '#furigana', { katakana: true });
    });
  </script>
</body>

</html>